"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const realm_utils_1 = require("realm-utils");
const CSSFile_1 = require("../../core/CSSFile");
class CSSModifications {
    static async perform(core, file) {
        if (!core.opts.shouldGenerateCSS()) {
            return;
        }
        const forRemoval = [];
        await realm_utils_1.each(file.requireStatements, (statement) => {
            if (statement.nodeModuleName === "fuse-box-css") {
                if (statement.ast.$parent && statement.ast.$parent.arguments) {
                    const args = statement.ast.$parent.arguments;
                    if (args.length !== 2) {
                        return;
                    }
                    const cssPath = args[0].value;
                    const cssRaw = args[1].value;
                    const cssFile = new CSSFile_1.CSSFile(cssPath, cssRaw);
                    core.cssCollection.add(cssFile);
                    core.postTasks.add(() => {
                        this.removeStatement(statement);
                    });
                    forRemoval.push(statement);
                }
            }
        });
        forRemoval.forEach(statement => {
            file.requireStatements.delete(statement);
        });
    }
    static removeStatement(statement) {
        const info = statement.removeCallExpression();
        const target = statement.file;
        if (info.success) {
            if (info.empty) {
                target.markForRemoval();
            }
            return;
        }
        target.dependents.forEach(dependent => {
            dependent.requireStatements.forEach(depStatement => {
                const targetStatement = depStatement.resolve();
                const matched = targetStatement === target;
                if (matched) {
                    depStatement.remove();
                }
            });
        });
    }
}
exports.CSSModifications = CSSModifications;
